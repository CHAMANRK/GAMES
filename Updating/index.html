<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="utf-8">
  <title>ğŸŒ™ Najiful Quran Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/auth.css">
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div class="header-content">
    <div class="header-branding">
      <img src="logo.png" alt="Logo" class="logo"/>
      <h1 class="app-title">Najiful Quran Game</h1>
    </div>
    <div class="header-actions">
      <div id="headerCoins" class="header-coins hidden">ğŸª™ <span id="coinCount">0</span></div>
      <span id="headerUser" class="header-user hidden"></span>
      <button class="icon-btn" id="feedbackBtn" title="Feedback">ğŸ“©</button>
      <button class="icon-btn" id="logoutBtn" style="display:none" title="Logout">ğŸšª</button>
    </div>
  </div>
</header>

<main>

  <!-- ===== AUTH SCREEN ===== -->
  <section id="authScreen" class="screen active">
    <div class="card auth-card">
      <div class="auth-banner">
        <span class="auth-banner-icon">ğŸŒ™</span>
        <h2>Najiful Quran Game</h2>
        <p>Login karein ya account banayein</p>
      </div>
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login" id="tabLogin">ğŸ” Login</button>
        <button class="auth-tab" data-tab="signup" id="tabSignup">ğŸ“ Signup</button>
      </div>
      <div class="auth-body">

        <!-- LOGIN PANEL -->
        <div id="loginPanel" class="auth-form-panel active">
          <div>
            <label class="auth-label">ğŸ“§ Email</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">ğŸ“§</span>
              <input id="loginEmail" type="email" placeholder="aapki@email.com">
            </div>
          </div>
          <div>
            <label class="auth-label">ğŸ”’ Password</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">ğŸ”’</span>
              <input id="loginPassword" type="password" placeholder="Password">
              <button class="toggle-pw" type="button" id="toggleLoginPw">ğŸ‘ï¸</button>
            </div>
          </div>
          <div class="auth-forgot" id="forgotBtn">Password bhool gaye? Reset karein</div>
          <div class="auth-msg" id="loginMsg"></div>
          <button id="loginBtn" class="btn btn-primary">ğŸ” Login</button>
          <div class="auth-divider">ya</div>
          <button id="googleLoginBtn" class="btn-google">
            <span class="google-icon"></span> Google se Login
          </button>
          <button id="guestBtn" class="btn-guest">ğŸ‘¤ Guest (3 sawaal free)</button>
        </div>

        <!-- SIGNUP PANEL -->
        <div id="signupPanel" class="auth-form-panel">
          <div>
            <label class="auth-label">ğŸ‘¤ Username</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">ğŸ‘¤</span>
              <input id="signupUsername" type="text" placeholder="apna_naam (3-20 chars)">
            </div>
          </div>
          <div>
            <label class="auth-label">ğŸ“§ Email</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">ğŸ“§</span>
              <input id="signupEmail" type="email" placeholder="aapki@email.com">
            </div>
          </div>
          <div>
            <label class="auth-label">ğŸ”’ Password</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">ğŸ”’</span>
              <input id="signupPassword" type="password" placeholder="Min 6 characters">
              <button class="toggle-pw" type="button" id="toggleSignupPw">ğŸ‘ï¸</button>
            </div>
          </div>
          <div>
            <label class="auth-label">âœ… Confirm Password</label>
            <div class="auth-input-wrap">
              <span class="auth-input-icon">âœ…</span>
              <input id="signupConfirmPw" type="password" placeholder="Dobara likhein">
            </div>
          </div>
          <div>
            <label class="auth-label">ğŸ¯ Aap kaun hain?</label>
            <input type="hidden" id="signupPlayerType" value="beginner">
            <div class="player-type-grid">
              <div class="player-type-option selected" data-type="beginner">
                <span class="pt-icon">ğŸŒ±</span>
                <span class="pt-name">Beginner</span>
                <span class="pt-desc">Naya shuruwaat</span>
              </div>
              <div class="player-type-option" data-type="intermediate">
                <span class="pt-icon">ğŸ“–</span>
                <span class="pt-name">Intermediate</span>
                <span class="pt-desc">Thoda tajruba</span>
              </div>
              <div class="player-type-option" data-type="pro">
                <span class="pt-icon">âš¡</span>
                <span class="pt-name">Pro</span>
                <span class="pt-desc">Kaafi maloomat</span>
              </div>
              <div class="player-type-option" data-type="hafiz">
                <span class="pt-icon">ğŸ‘‘</span>
                <span class="pt-name">Hafiz</span>
                <span class="pt-desc">Admin verified</span>
              </div>
            </div>
          </div>
          <div class="auth-msg" id="signupMsg"></div>
          <button id="signupBtn" class="btn btn-primary">ğŸ“ Account Banayein</button>
          <div class="auth-divider">ya</div>
          <button id="googleSignupBtn" class="btn-google">
            <span class="google-icon"></span> Google se Signup
          </button>
          <p class="auth-terms">500 ğŸª™ coins shuruwaat mein milenge!</p>
        </div>

      </div>
    </div>
  </section>

  <!-- ===== HOME SCREEN ===== -->
  <section id="welcomeScreen" class="screen">
    <div class="card home-card">
      <h2 class="main-heading">ğŸŒ™ Quran Ayat Quiz</h2>
      <p class="subtitle">Apni Quran maloomat ko aazmaayiye!</p>
      <form id="modeForm" class="mode-group" style="width:100%">
        <label class="mode-option">
          <input type="radio" name="quizMode" value="practice" checked>
          <span>ğŸ¯ Practice Mode â€” Unlimited</span>
        </label>
        <label class="mode-option">
          <input type="radio" name="quizMode" value="timed">
          <span>â±ï¸ Timed â€” 10 Qs, 30 sec each</span>
        </label>
        <label class="mode-option">
          <input type="radio" name="quizMode" value="survival">
          <span>ğŸ’¥ Survival â€” Ek galti = game over</span>
        </label>
      </form>
      <button class="btn btn-primary" id="goParaSelect">â–¶ï¸ Shuru Karein</button>
      <button class="btn btn-secondary" id="toggleSearchBtn">ğŸ” Search</button>
    </div>
    <div class="search-section" id="searchContainer" style="display:none">
      <form id="searchForm">
        <input id="searchInput" type="text" placeholder="Ayat, Surah, Page, Para...">
        <button type="submit" class="btn btn-primary" style="width:auto;padding:11px 18px">Search</button>
      </form>
      <div id="searchResults"></div>
    </div>
  </section>

  <!-- ===== PARA SELECT ===== -->
  <section id="paraSelectScreen" class="screen">
    <div class="card">
      <h2 class="main-heading">ğŸŒ™ Para Range</h2>
      <form id="paraForm" style="width:100%">
        <div class="input-grid">
          <div class="input-group">
            <label class="input-label">From Para (1â€“30)</label>
            <input id="fromPara" type="number" min="1" max="30" placeholder="1">
          </div>
          <div class="input-group">
            <label class="input-label">To Para (1â€“30)</label>
            <input id="toPara" type="number" min="1" max="30" placeholder="30">
          </div>
        </div>
        <div id="selectError" class="error hidden"></div>
        <button class="btn btn-primary" type="submit">âœ… Submit</button>
      </form>
      <button class="btn btn-outline" id="backFromPara">â¬…ï¸ Wapas</button>
    </div>
  </section>

  <!-- ===== QUIZ SCREEN ===== -->
  <section id="quizScreen" class="screen">
    <div class="card" style="max-width:540px">
      <div id="quizProgress" style="color:var(--text-secondary);font-size:.92em;text-align:center"></div>
      <h2 class="main-heading">ğŸ“– Ye Ayat Pehchaniye</h2>
      <div id="ayatText" class="ayat" dir="rtl"></div>
      <div style="display:flex;align-items:center;gap:12px;width:100%">
        <button id="hintBtn" class="btn btn-secondary" style="width:auto;padding:9px 20px">ğŸ’¡ Hint</button>
        <span id="hintInfo" style="color:var(--emerald);font-size:.9em"></span>
      </div>
      <form id="answerForm" style="width:100%">
        <p class="section-label">âœ… Zaroori</p>
        <div class="input-grid">
          <div class="input-group">
            <label class="input-label">Para Number</label>
            <input id="user_para" type="number" min="1" max="30" placeholder="Para No.">
          </div>
          <div class="input-group">
            <label class="input-label">Page In Para</label>
            <input id="user_page_in_para" type="number" min="1" max="20" placeholder="PiP">
          </div>
        </div>
        <p class="section-label">â­ Optional <span style="color:var(--gold);font-size:.8em;font-weight:400">(+5ğŸª™ each)</span></p>
        <div class="input-grid">
          <div class="input-group">
            <label class="input-label">Page No.</label>
            <input id="user_page" type="number" min="1" max="604" placeholder="Page">
          </div>
          <div class="input-group">
            <label class="input-label">Surah Name</label>
            <input id="user_surah" type="text" placeholder="Surah">
          </div>
          <div class="input-group">
            <label class="input-label">Ruku No.</label>
            <input id="user_ruku" type="number" min="1" placeholder="Ruku">
          </div>
          <div class="input-group">
            <label class="input-label">Ayat No.</label>
            <input id="user_ayat" type="number" min="1" placeholder="Ayat">
          </div>
        </div>
        <button class="btn btn-primary" type="submit">âœ… Check Karo</button>
      </form>
      <div id="quizError" class="error hidden"></div>
      <div id="quizResult" class="result hidden"></div>
      <div id="survivalAnswer" class="hidden" style="background:linear-gradient(135deg,#180e00,#100900);border:1px solid var(--gold);border-radius:var(--radius-sm);padding:14px;width:100%;text-align:center;color:var(--gold-light);line-height:1.8"></div>
      <button class="btn btn-secondary next-button hidden" id="nextBtn">â¡ï¸ Agla Sawal</button>
      <button class="btn btn-outline" id="backFromQuiz">â¬…ï¸ Wapas</button>
      <div id="scoreBoard" style="color:var(--emerald);font-weight:700;text-align:center"></div>
      <div id="timer" style="color:var(--gold-light);font-weight:700;text-align:center;font-family:'Cinzel',serif;letter-spacing:2px"></div>
    </div>
  </section>

  <!-- ===== RESULT SCREEN ===== -->
  <section id="resultScreen" class="screen">
    <div class="card">
      <h2 class="main-heading">ğŸ‰ Quiz Khatam!</h2>
      <div id="finalResult" class="result-summary"></div>
      <button class="btn btn-primary" id="goHomeBtn">ğŸ  Home</button>
      <button class="btn btn-outline" id="playAgainBtn">ğŸ”„ Dobara Khelo</button>
    </div>
  </section>

  <!-- ===== CONTACT SCREEN ===== -->
  <section id="contactScreen" class="screen">
    <div class="card" style="max-width:460px">
      <h2 class="main-heading">ğŸ“© Raabta</h2>
      <form action="https://formsubmit.co/hellochaman532@gmail.com" method="POST" style="width:100%">
        <input type="hidden" name="_captcha" value="false">
        <div class="input-group" style="margin-bottom:12px">
          <label class="input-label">Naam</label>
          <input type="text" name="name" required>
        </div>
        <div class="input-group" style="margin-bottom:12px">
          <label class="input-label">Email</label>
          <input type="email" name="email" required>
        </div>
        <div class="input-group" style="margin-bottom:12px">
          <label class="input-label">Paighaam</label>
          <textarea name="message" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">ğŸ“¤ Bhejain</button>
      </form>
      <button class="btn btn-outline" id="backFromContact">â¬…ï¸ Wapas</button>
    </div>
  </section>

</main>

<footer class="app-footer">Â© 2025 Najiful Quran Game</footer>

<!-- Welcome Popup -->
<div id="welcomePopup" class="welcome-popup">
  <div class="wp-name" id="wpName">Marhaba! ğŸŒ™</div>
  <div class="wp-coins" id="wpCoins">ğŸª™ 500 coins</div>
</div>

<!-- Guest Limit Modal -->
<div id="guestModal" style="display:none;position:fixed;inset:0;background:rgba(5,15,10,.93);backdrop-filter:blur(10px);z-index:9000;align-items:center;justify-content:center">
  <div class="card" style="max-width:360px;gap:16px;text-align:center">
    <span style="font-size:3rem">ğŸ”</span>
    <h3 class="main-heading" style="font-size:1.4rem">3 Sawaal Pure!</h3>
    <p class="subtitle">Login karo â€” coins save hon aur online khelo!</p>
    <button class="btn btn-primary" id="guestToSignup">ğŸ“ Account Banayein</button>
    <button class="btn btn-outline" id="guestContinue">Jari Rakhein</button>
  </div>
</div>

<!-- Stars Canvas -->
<canvas id="starsCanvas" style="position:fixed;inset:0;z-index:0;pointer-events:none"></canvas>

<!-- Stars Animation (plain JS) -->
<script>
(function(){
  var c=document.getElementById('starsCanvas'),x=c.getContext('2d'),s=[];
  function rs(){c.width=innerWidth;c.height=innerHeight;}
  function is(){
    s=[];
    var n=Math.floor(c.width*c.height/8000);
    for(var i=0;i<n;i++) s.push({
      x:Math.random()*c.width, y:Math.random()*c.height,
      r:Math.random()*1.2+.2, a:Math.random(),
      sp:Math.random()*.005+.001,
      col:Math.random()>.7?'#d4a843':'#00c472'
    });
  }
  function dr(){
    x.clearRect(0,0,c.width,c.height);
    s.forEach(function(p){
      p.a+=p.sp; if(p.a>1||p.a<0)p.sp=-p.sp;
      x.save(); x.globalAlpha=Math.abs(Math.sin(p.a));
      x.beginPath(); x.arc(p.x,p.y,p.r,0,Math.PI*2);
      x.fillStyle=p.col; x.shadowBlur=6; x.shadowColor=p.col;
      x.fill(); x.restore();
    });
    requestAnimationFrame(dr);
  }
  rs(); is(); dr();
  addEventListener('resize',function(){rs();is();});
})();
</script>

<!-- MAIN APP -->
<script type="module">
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE â€” New Project Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signInWithPopup,
  signInAnonymously,
  GoogleAuthProvider,
  signOut,
  onAuthStateChanged,
  sendPasswordResetEmail,
  updateProfile
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import {
  getFirestore,
  doc, setDoc, getDoc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyDnAGW2eDe3ao1ezTf7fykUSfhyReQDgJM",
  authDomain:        "quran-quiz-3ee30.firebaseapp.com",
  databaseURL:       "https://quran-quiz-3ee30-default-rtdb.firebaseio.com",
  projectId:         "quran-quiz-3ee30",
  storageBucket:     "quran-quiz-3ee30.firebasestorage.app",
  messagingSenderId: "362662301719",
  appId:             "1:362662301719:web:e5fa7bd4adf633758e8c52",
  measurementId:     "G-CVQTH5SS0X"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const GP   = new GoogleAuthProvider();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let quranData=[], curUser=null, curData=null, guestN=0;
let selAyats=[], curAyat=null;
let qIdx=0, score=0, totalQ=10, mode='practice';
let usedI=[], surahC={}, startT=0, qTmr=null, timeArr=[], survOn=true, hints=0;
const MAX_H=2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $  = id => document.getElementById(id);
const on = (id, ev, fn) => $(id) && $(id).addEventListener(ev, fn);

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $(id) && $(id).classList.add('active');
  if (id !== 'welcomeScreen') {
    const sc = $('searchContainer');
    if (sc) sc.style.display = 'none';
    const tb = $('toggleSearchBtn');
    if (tb) tb.textContent = 'ğŸ” Search';
  }
}

function toast(msg, type='info', dur=3000) {
  let t = document.getElementById('_toast');
  if (!t) {
    t = document.createElement('div');
    t.id = '_toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.className = `toast toast-${type} toast-show`;
  clearTimeout(t._tmr);
  t._tmr = setTimeout(() => t.classList.remove('toast-show'), dur);
}

function setMsg(id, msg, type='error') {
  const el = $(id);
  if (!el) return;
  el.textContent = msg;
  el.className = `auth-msg ${type} show`;
}

function clearMsgs() {
  document.querySelectorAll('.auth-msg').forEach(m => {
    m.className = 'auth-msg';
    m.textContent = '';
  });
}

function btnLoad(id, on, orig) {
  const b = $(id);
  if (!b) return;
  b.disabled = on;
  if (on) { b._o = b.textContent; b.textContent = 'â³'; }
  else b.textContent = orig || b._o || b.textContent;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEADER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHeader() {
  if (curUser && !curUser.isAnonymous) {
    const coins = $('coinCount');
    if (coins) coins.textContent = (curData?.coins || 0).toLocaleString();
    $('headerCoins')?.classList.remove('hidden');
    const u = $('headerUser');
    if (u) {
      u.textContent = curData?.isHafiz
        ? `ğŸ‘‘ ${curData.username}`
        : `ğŸ‘¤ ${curData?.username || curUser.displayName || 'Player'}`;
      u.classList.remove('hidden');
    }
    const lb = $('logoutBtn');
    if (lb) lb.style.display = 'inline-flex';
  } else {
    $('headerCoins')?.classList.add('hidden');
    $('headerUser')?.classList.add('hidden');
    const lb = $('logoutBtn');
    if (lb) lb.style.display = 'none';
  }
}

function showWelcomePopup(name, coins, isNew=false) {
  const p = $('welcomePopup');
  if (!p) return;
  $('wpName').textContent  = isNew ? `Ahlan, ${name}! ğŸŒ™` : `Marhaba, ${name}! ğŸŒ™`;
  $('wpCoins').textContent = `ğŸª™ ${coins} coins`;
  p.classList.add('show');
  setTimeout(() => p.classList.remove('show'), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIRESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncUser(uid, data) {
  try {
    const ref  = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      const nd = {
        uid,
        username:     data.username    || 'Player',
        email:        data.email       || '',
        playerType:   data.playerType  || 'beginner',
        coins:        500,
        xp:           0,
        level:        1,
        accuracy:     0,
        totalGames:   0,
        totalWins:    0,
        totalCorrect: 0,
        streak:       0,
        lastLogin:    serverTimestamp(),
        createdAt:    serverTimestamp(),
        isGuest:      false,
        isHafiz:      false,
        role:         'user',
        avatar:       'default',
        onlineMode:   false,
        badges:       [],
        friends:      [],
        bookmarks:    []
      };
      await setDoc(ref, nd);
      curData = nd;
    } else {
      curData = snap.data();
      updateDoc(ref, { lastLogin: serverTimestamp() }).catch(() => {});
    }
    updateHeader();
    // Online mode unlock check
    if (curData && !curData.onlineMode && curData.coins >= 800) {
      updateDoc(ref, { onlineMode: true }).catch(() => {});
      toast('ğŸ‰ Online Mode unlock ho gaya!', 'success', 4000);
    }
  } catch(e) {
    console.warn('Firestore error:', e.code, e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE ERROR MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fbErr(code) {
  const map = {
    'auth/email-already-in-use':   'âŒ Email pehle se registered hai.',
    'auth/invalid-email':          'âŒ Sahi email format likhein.',
    'auth/user-not-found':         'âŒ Email registered nahi.',
    'auth/wrong-password':         'âŒ Password galat hai.',
    'auth/invalid-credential':     'âŒ Email ya password galat hai.',
    'auth/weak-password':          'âŒ Password min 6 characters chahiye.',
    'auth/too-many-requests':      'âŒ Zyada try â€” thodi der baad koshish karein.',
    'auth/network-request-failed': 'âŒ Internet connection check karein.',
    'auth/popup-blocked':          'âŒ Popup block hai â€” browser mein allow karein.',
    'auth/operation-not-allowed':  'âŒ Yeh method enable nahi â€” Firebase console check karein.',
    'auth/configuration-not-found':'âŒ Firebase config galat hai.',
  };
  return map[code] || `âŒ Error (${code})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  clearMsgs();
  const email = $('loginEmail').value.trim();
  const pw    = $('loginPassword').value;
  if (!email || !pw) { setMsg('loginMsg', 'âŒ Email aur password likhein!'); return; }
  btnLoad('loginBtn', true);
  try {
    const c = await signInWithEmailAndPassword(auth, email, pw);
    showScreen('welcomeScreen');
    toast('âœ… Login ho gaye!', 'success');
    syncUser(c.user.uid, {
      username: c.user.displayName || email.split('@')[0],
      email: c.user.email
    });
  } catch(e) {
    setMsg('loginMsg', fbErr(e.code));
    btnLoad('loginBtn', false, 'ğŸ” Login');
  }
}

async function doSignup() {
  clearMsgs();
  const un  = $('signupUsername').value.trim();
  const em  = $('signupEmail').value.trim();
  const pw  = $('signupPassword').value;
  const cpw = $('signupConfirmPw').value;
  const pt  = $('signupPlayerType').value || 'beginner';

  if (!un || !em || !pw || !cpw) { setMsg('signupMsg', 'âŒ Sab fields bharen!'); return; }
  if (un.length < 3 || un.length > 20 || !/^[a-zA-Z0-9_]+$/.test(un)) {
    setMsg('signupMsg', 'âŒ Username: 3-20 chars, letters/numbers/_ sirf.'); return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)) { setMsg('signupMsg', 'âŒ Sahi email likhein.'); return; }
  if (pw.length < 6)  { setMsg('signupMsg', 'âŒ Password min 6 characters.'); return; }
  if (pw !== cpw)     { setMsg('signupMsg', 'âŒ Passwords match nahi!'); return; }

  btnLoad('signupBtn', true);
  try {
    const c = await createUserWithEmailAndPassword(auth, em, pw);
    await updateProfile(c.user, { displayName: un });
    showScreen('welcomeScreen');
    showWelcomePopup(un, 500, true);
    toast('âœ… Account ban gaya! 500ğŸª™ mile!', 'success');
    syncUser(c.user.uid, { username: un, email: em, playerType: pt });
  } catch(e) {
    setMsg('signupMsg', fbErr(e.code));
    btnLoad('signupBtn', false, 'ğŸ“ Account Banayein');
  }
}

async function doGoogle() {
  clearMsgs();
  const btn = $('googleLoginBtn') || $('googleSignupBtn');
  if (btn) btn.disabled = true;
  try {
    const r    = await signInWithPopup(auth, GP);
    const name = r.user.displayName || r.user.email.split('@')[0];
    const isNew = r._tokenResponse?.isNewUser || false;
    showScreen('welcomeScreen');
    showWelcomePopup(name, isNew ? 500 : curData?.coins || 0, isNew);
    toast('âœ… Google se login ho gaye!', 'success');
    syncUser(r.user.uid, { username: name, email: r.user.email, playerType: 'beginner' });
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') setMsg('loginMsg', fbErr(e.code));
  }
  if (btn) btn.disabled = false;
}

async function doGuest() {
  btnLoad('guestBtn', true);
  try {
    await signInAnonymously(auth);
    guestN = 0;
    showScreen('welcomeScreen');
    toast('ğŸ‘¤ Guest mode â€” 3 sawaal free!', 'info', 4000);
  } catch(e) {
    setMsg('loginMsg', fbErr(e.code));
    btnLoad('guestBtn', false, 'ğŸ‘¤ Guest (3 sawaal free)');
  }
}

async function doLogout() {
  await signOut(auth);
  curUser = curData = null;
  updateHeader();
  showScreen('authScreen');
  toast('ğŸ‘‹ Phir aana!', 'info');
}

async function doForgot() {
  const em = $('loginEmail').value.trim();
  if (!em) { setMsg('loginMsg', 'âŒ Pehle email likhein!'); return; }
  try {
    await sendPasswordResetEmail(auth, em);
    setMsg('loginMsg', 'ğŸ“§ Reset email bhej diya!', 'success');
  } catch(e) {
    setMsg('loginMsg', fbErr(e.code));
  }
}

function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
  document.querySelectorAll('.auth-form-panel').forEach(p => p.classList.remove('active'));
  $(`${tab}Panel`)?.classList.add('active');
  clearMsgs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH STATE LISTENER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
onAuthStateChanged(auth, async user => {
  curUser = user;
  if (user) {
    if (!user.isAnonymous) {
      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (snap.exists()) { curData = snap.data(); }
      } catch(e) { console.warn('Auth state:', e.message); }
      updateHeader();
    }
    // Agar auth screen active hai toh home pe jao
    if ($('authScreen')?.classList.contains('active')) {
      showScreen('welcomeScreen');
      if (curData) showWelcomePopup(curData.username, curData.coins);
    }
  } else {
    curData = null;
    updateHeader();
    showScreen('authScreen');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadQuran() {
  try {
    const res  = await fetch('quran_full.json');
    quranData  = await res.json();
    console.log('âœ… Quran loaded:', quranData.length, 'ayats');
  } catch(e) {
    console.error('âŒ Quran load fail:', e);
  }
}

function startGame() {
  const fp = parseInt($('fromPara').value);
  const tp = parseInt($('toPara').value);
  const er = $('selectError');
  er.classList.add('hidden');
  if (isNaN(fp) || isNaN(tp) || fp < 1 || tp > 30 || fp > tp) {
    er.textContent = 'âŒ Galat range! Para 1â€“30, From â‰¤ To.';
    er.classList.remove('hidden'); return;
  }
  if (!quranData.length) {
    er.textContent = 'âŒ Quran data load nahi hua. Page reload karein.';
    er.classList.remove('hidden'); return;
  }
  selAyats = quranData.filter(a => {
    const p = ((a.page - 1) / 20 | 0) + 1;
    return p >= fp && p <= tp;
  });
  if (!selAyats.length) {
    er.textContent = 'âŒ Is range mein ayat nahi mile.';
    er.classList.remove('hidden'); return;
  }
  qIdx=0; score=0; usedI=[]; surahC={}; timeArr=[]; hints=0; survOn=true;
  mode  = document.querySelector('input[name="quizMode"]:checked')?.value || 'practice';
  totalQ = mode === 'timed' ? 10 : 9999;
  $('hintBtn').disabled = false;
  $('hintInfo').textContent = `Hint: 0/${MAX_H}`;
  $('survivalAnswer').classList.add('hidden');
  nextQ();
  showScreen('quizScreen');
}

function nextQ() {
  ['quizError','quizResult','survivalAnswer'].forEach(id => $(id)?.classList.add('hidden'));
  $('answerForm')?.reset();
  $('nextBtn')?.classList.add('hidden');
  $('hintBtn').disabled = hints >= MAX_H;
  $('hintInfo').textContent = `Hint: ${hints}/${MAX_H}`;
  if (qIdx >= totalQ || usedI.length >= selAyats.length) { endQuiz(); return; }
  let i, t = 0;
  do { i = Math.floor(Math.random() * selAyats.length); t++; }
  while (usedI.includes(i) && t < 1000);
  usedI.push(i);
  curAyat = selAyats[i];
  typeText(curAyat.text);
  qIdx++;
  $('scoreBoard').textContent = `Score: ${score} / ${qIdx}`;
  $('quizProgress').textContent =
    mode === 'practice' ? `ğŸ¯ Sawal: ${qIdx}` :
    mode === 'survival' ? `ğŸ’¥ Sawal: ${qIdx}` :
    `â±ï¸ ${qIdx} / ${totalQ}`;
  startT = Date.now();
  if (mode === 'timed') startTimer(30);
  else $('timer').textContent = '';
}

function typeText(text) {
  const el = $('ayatText');
  el.textContent = '';
  let i = 0;
  const go = () => { if (i < text.length) { el.textContent += text[i++]; setTimeout(go, 20); } };
  go();
}

function startTimer(sec) {
  let t = sec;
  const el = $('timer');
  el.textContent = `â±ï¸ ${t}s`;
  el.classList.remove('urgent');
  if (qTmr) clearInterval(qTmr);
  qTmr = setInterval(() => {
    t--;
    el.textContent = `â±ï¸ ${t}s`;
    if (t <= 10) el.classList.add('urgent');
    if (t <= 0) {
      clearInterval(qTmr);
      el.textContent = "â±ï¸ Time's up!";
      el.classList.remove('urgent');
      timeArr.push(sec);
      showRes("â±ï¸ Waqt khatam! Agla sawal...", false);
      $('nextBtn')?.classList.remove('hidden');
    }
  }, 1000);
}

function checkAnswer() {
  if (mode === 'timed' && qTmr) clearInterval(qTmr);
  const ts  = Math.round((Date.now() - startT) / 1000);
  const para = $('user_para').value.trim();
  const pip  = $('user_page_in_para').value.trim();
  const pg   = $('user_page').value.trim();
  const sur  = $('user_surah').value.trim().toLowerCase();
  const rk   = $('user_ruku').value.trim();
  const ay   = $('user_ayat').value.trim();

  ['quizError','quizResult'].forEach(id => $(id)?.classList.add('hidden'));
  $('nextBtn')?.classList.add('hidden');
  $('survivalAnswer').classList.add('hidden');

  if (!para) { showErr('âŒ Para Number zaroori hai!'); return; }

  const pn  = parseInt(curAyat.page);
  const ap  = ((pn - 1) / 20 | 0) + 1;
  const aip = ((pn - 1) % 20) + 1;

  let parts = [], opt = 0;
  const pOk = parseInt(para) === ap;
  if (!pOk) parts.push(`âŒ Para Galat! Sahi: ${ap}`);

  let pipOk = true;
  if (pip) {
    pipOk = parseInt(pip) === aip - 1;
    if (!pipOk) parts.push(`âŒ Page in Para Galat! Sahi: ${aip - 1}`);
  }
  if (pg)  { if (parseInt(pg)  === pn)            opt++; else parts.push(`âŒ Page No. Galat! Sahi: ${pn}`); }
  if (sur) { if (curAyat.surah_name.toLowerCase().includes(sur)) opt++; else parts.push(`âŒ Surah Galat! Sahi: ${curAyat.surah_name}`); }
  if (rk && curAyat.ruku_no !== undefined) { if (parseInt(rk) === curAyat.ruku_no) opt++; else parts.push(`âŒ Ruku Galat! Sahi: ${curAyat.ruku_no}`); }
  if (ay && curAyat.ayat_no !== undefined) { if (parseInt(ay) === curAyat.ayat_no) opt++; else parts.push(`âŒ Ayat No. Galat! Sahi: ${curAyat.ayat_no}`); }

  const ok = pOk && (pip ? pipOk : true);

  if (ok) {
    score++;
    surahC[curAyat.surah_name] = (surahC[curAyat.surah_name] || 0) + 1;
    const base = Math.max(10, 15 - Math.floor(ts / 5));
    const optC = opt * 5;
    showRes(`âœ… Sahi! +${base}ğŸª™${optC ? ` + ${optC}ğŸª™ optional = ${base + optC}ğŸª™` : ''}`, true);
  } else {
    showRes(parts.join('<br>') || 'âŒ Galat!', false);
    if (mode === 'survival') {
      survOn = false;
      const sd = $('survivalAnswer');
      sd.innerHTML = `<b>Sahi Jawab:</b><br>Surah: <b>${curAyat.surah_name}</b> | Para: <b>${ap}</b> | Page: <b>${pn}</b> | PiP: <b>${aip - 1}</b>`;
      sd.classList.remove('hidden');
      timeArr.push(ts);
      $('scoreBoard').textContent = `Score: ${score} / ${qIdx}`;
      setTimeout(endQuiz, 2200);
      return;
    }
  }
  $('nextBtn')?.classList.remove('hidden');
  timeArr.push(ts);
  $('scoreBoard').textContent = `Score: ${score} / ${qIdx}`;
}

function showRes(msg, ok) {
  const d = $('quizResult');
  d.innerHTML = msg;
  d.className = ok ? 'result' : 'error';
  d.classList.remove('hidden');
  if (ok) setTimeout(() => d.classList.add('hidden'), 4000);
}

function showErr(msg) {
  const e = $('quizError');
  e.textContent = msg;
  e.classList.remove('hidden');
  setTimeout(() => e.classList.add('hidden'), 2500);
}

function showHint() {
  if (hints >= MAX_H) return;
  hints++;
  $('hintInfo').textContent = `Hint: ${hints}/${MAX_H}`;
  if (hints >= MAX_H) $('hintBtn').disabled = true;
  const ap = ((parseInt(curAyat.page) - 1) / 20 | 0) + 1;
  const s2 = curAyat.surah_name.split(' ').slice(0, 2).join(' ');
  const e  = $('quizError');
  e.innerHTML = `ğŸ’¡ <b>Hint:</b> Surah: <b>${s2}...</b>, Para: <b>${ap}</b>`;
  e.classList.remove('hidden');
  setTimeout(() => e.classList.add('hidden'), 3500);
}

function endQuiz() {
  if (qTmr) clearInterval(qTmr);
  let best = '', mx = 0;
  Object.entries(surahC).forEach(([s, c]) => { if (c > mx) { mx = c; best = s; } });
  const avg = timeArr.length ? Math.round(timeArr.reduce((a, b) => a + b, 0) / timeArr.length) : 0;
  $('finalResult').innerHTML = `
    ğŸ§  Score: <b>${score} / ${qIdx}</b><br>
    ğŸ“– Best Surah: <b>${best || 'â€”'}</b><br>
    â±ï¸ Avg Time: <b>${avg} sec</b><br><br>
    ${mode === 'survival' && !survOn ? 'ğŸ’¥ Survival Khatam!' : 'ğŸ‰ Mubarak!'}
  `;
  showScreen('resultScreen');
}

function resetGame(home) {
  qIdx=0; score=0; usedI=[]; surahC={}; timeArr=[]; hints=0; survOn=true;
  if (qTmr) clearInterval(qTmr);
  $('hintBtn').disabled = false;
  $('hintInfo').textContent = `Hint: 0/${MAX_H}`;
  showScreen(home ? 'welcomeScreen' : 'paraSelectScreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rmD(t) { return t.replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g, ''); }

function doSearch(e) {
  if (e) e.preventDefault();
  const q  = rmD($('searchInput').value.trim().toLowerCase());
  const rd = $('searchResults');
  if (!q)             { rd.innerHTML = '<em>Kuch likhein...</em>'; return; }
  if (!quranData.length) { rd.innerHTML = '<em>Data load ho raha hai...</em>'; return; }
  const found = quranData.filter(a =>
    rmD(a.text.toLowerCase()).includes(q) ||
    rmD(a.surah_name.toLowerCase()).includes(q) ||
    String(a.page) === q ||
    String(((a.page - 1) / 20 | 0) + 1) === q
  ).slice(0, 30);
  if (!found.length) { rd.innerHTML = '<b>Koi result nahi mila.</b>'; return; }
  const hl = (t) => t.split(/(\s+)/).map(w => rmD(w.toLowerCase()) === q ? `<mark>${w}</mark>` : w).join('');
  rd.innerHTML = found.map(r => {
    const ap = ((r.page - 1) / 20 | 0) + 1;
    return `<div class="search-result" onclick="window.open('https://quran.com/page/${r.page}','_blank')">
      <b>Ayat:</b> ${hl(r.text)}<br>
      <b>Surah:</b> ${hl(r.surah_name)} | <b>Page:</b> ${r.page} | <b>Para:</b> ${ap}
      <span style="float:right;color:#aad">ğŸ”—</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT BINDINGS â€” sab addEventListener
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Auth tabs
on('tabLogin',  'click', () => switchTab('login'));
on('tabSignup', 'click', () => switchTab('signup'));

// Auth buttons
on('loginBtn',         'click', doLogin);
on('signupBtn',        'click', doSignup);
on('googleLoginBtn',   'click', doGoogle);
on('googleSignupBtn',  'click', doGoogle);
on('guestBtn',         'click', doGuest);
on('logoutBtn',        'click', doLogout);
on('forgotBtn',        'click', doForgot);

// Password visibility toggle
on('toggleLoginPw', 'click', function() {
  const i = $('loginPassword');
  i.type = i.type === 'password' ? 'text' : 'password';
  this.textContent = i.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
});
on('toggleSignupPw', 'click', function() {
  const i = $('signupPassword');
  i.type = i.type === 'password' ? 'text' : 'password';
  this.textContent = i.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
});

// Player type selection
document.querySelectorAll('.player-type-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('.player-type-option').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    $('signupPlayerType').value = opt.dataset.type;
  });
});

// Enter key shortcuts
on('loginPassword',   'keydown', e => { if (e.key === 'Enter') doLogin(); });
on('signupConfirmPw', 'keydown', e => { if (e.key === 'Enter') doSignup(); });

// Navigation
on('feedbackBtn',     'click', () => showScreen('contactScreen'));
on('goParaSelect',    'click', () => showScreen('paraSelectScreen'));
on('backFromPara',    'click', () => showScreen('welcomeScreen'));
on('backFromQuiz',    'click', () => showScreen('welcomeScreen'));
on('backFromContact', 'click', () => showScreen('welcomeScreen'));
on('goHomeBtn',       'click', () => resetGame(true));
on('playAgainBtn',    'click', () => resetGame(false));
on('nextBtn',         'click', nextQ);
on('hintBtn',         'click', showHint);

// Forms
on('paraForm',   'submit', e => { e.preventDefault(); startGame(); });
on('answerForm', 'submit', e => { e.preventDefault(); checkAnswer(); });
on('searchForm', 'submit', doSearch);
on('searchInput','keydown', e => { if (e.key === 'Enter') doSearch(e); });

// Mode radio
on('modeForm', 'change', () => {
  mode = document.querySelector('input[name="quizMode"]:checked')?.value || 'practice';
});

// Search toggle
on('toggleSearchBtn', 'click', () => {
  const sc  = $('searchContainer');
  const btn = $('toggleSearchBtn');
  if (sc.style.display === 'none' || !sc.style.display) {
    sc.style.display = 'block';
    btn.textContent  = 'âŒ Band Karein';
    $('searchInput')?.focus();
  } else {
    sc.style.display = 'none';
    btn.textContent  = 'ğŸ” Search';
  }
});

// Guest modal
on('guestToSignup', 'click', () => {
  $('guestModal').style.display = 'none';
  showScreen('authScreen');
  switchTab('signup');
});
on('guestContinue', 'click', () => {
  $('guestModal').style.display = 'none';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadQuran();

</script>
</body>
</html>
