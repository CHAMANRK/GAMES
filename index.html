<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Universal Video Downloader - YouTube & Instagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-700 text-white flex flex-col items-center justify-center min-h-screen p-5">
  <main class="w-full flex flex-col items-center">
    <div class="w-full text-center p-4 rounded-b-xl bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold text-2xl shadow-lg">
      üöÄ Universal Video Downloader
    </div>
    <form id="downloaderForm" class="flex flex-col space-y-3 mt-5 w-80 bg-gray-800 p-5 rounded-xl shadow-lg" autocomplete="off">
      <input id="url" placeholder="Paste YouTube or Instagram link" required class="p-3 rounded text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
      <select id="site" class="p-3 rounded text-gray-800">
        <option value="youtube">YouTube</option>
        <option value="instagram">Instagram</option>
      </select>
      <select id="format" class="p-3 rounded text-gray-800">
        <option value="mp4">mp4 (Video)</option>
        <option value="mp3">mp3 (Audio, YouTube only)</option>
      </select>
      <select id="quality" class="p-3 rounded text-gray-800 hidden"></select>
      <button type="submit" class="bg-yellow-400 hover:bg-yellow-500 rounded p-3 text-gray-900 font-bold">
        ‚¨áÔ∏è Download
      </button>
    </form>
    <div id="result" class="mt-5 text-center"></div>
  </main>
  <script>
    const urlInput = document.getElementById('url');
    const siteInput = document.getElementById('site');
    const formatInput = document.getElementById('format');
    const qualityInput = document.getElementById('quality');
    const resultDiv = document.getElementById('result');
    const form = document.getElementById('downloaderForm');

    function resetQuality() {
      qualityInput.innerHTML = '';
      qualityInput.classList.add('hidden');
    }

    async function fetchYoutubeQualities(videoURL, format) {
      resultDiv.innerHTML = 'üîé Fetching qualities...';
      const apiUrl = `https://api.vevioz.com/api/button/${format}?url=${encodeURIComponent(videoURL)}`;
      try {
        const res = await fetch(apiUrl, {mode: 'cors'});
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const buttons = Array.from(doc.querySelectorAll('.download-mp4, .download-mp3, .download-audio, .download-video'));
        let opts = [];
        for (const btn of buttons) {
          let text = btn.textContent.trim();
          let href = btn.getAttribute('href');
          if (href && text) {
            opts.push({text, href: 'https://api.vevioz.com' + href});
          }
        }
        if (opts.length > 0) {
          qualityInput.innerHTML = opts.map((x, i) => `<option value="${i}">${x.text}</option>`).join('');
          qualityInput.classList.remove('hidden');
          qualityInput.dataset.options = JSON.stringify(opts);
          resultDiv.innerHTML = '‚úÖ Quality options loaded. Select and download!';
        } else {
          resetQuality();
          resultDiv.innerHTML = '‚ùå No qualities found. Try another link.';
        }
      } catch (err) {
        resetQuality();
        resultDiv.innerHTML = '‚ùå Error fetching qualities. Try again.';
      }
    }

    urlInput.addEventListener('change', async function() {
      const site = siteInput.value;
      const format = formatInput.value;
      if (site === 'youtube' && urlInput.value.trim()) {
        await fetchYoutubeQualities(urlInput.value.trim(), format);
      } else {
        resetQuality();
      }
    });

    siteInput.addEventListener('change', function() {
      if (siteInput.value === 'youtube' && urlInput.value.trim()) {
        fetchYoutubeQualities(urlInput.value.trim(), formatInput.value);
      } else {
        resetQuality();
      }
    });

    formatInput.addEventListener('change', function() {
      if (siteInput.value === 'youtube' && urlInput.value.trim()) {
        fetchYoutubeQualities(urlInput.value.trim(), formatInput.value);
      } else {
        resetQuality();
      }
    });

    form.onsubmit = async function(e) {
      e.preventDefault();
      const url = urlInput.value.trim();
      const site = siteInput.value;
      const format = formatInput.value;
      if (!url) {
        resultDiv.innerHTML = "‚ùå Please enter a link!";
        return;
      }
      // YOUTUBE
      if (site === "youtube") {
        if (!qualityInput.classList.contains('hidden')) {
          const opts = JSON.parse(qualityInput.dataset.options || '[]');
          const selected = qualityInput.selectedIndex;
          if (opts[selected]) {
            // Try to open in new tab for download
            let win = window.open(opts[selected].href, '_blank');
            if(!win){
              resultDiv.innerHTML = `‚ùó Popup blocked! Please allow popups for this site. Or <a class='underline text-yellow-300' href='${opts[selected].href}' target='_blank'>click here</a>.`;
            }else{
              resultDiv.innerHTML = `üîó Download should start automatically. If not, <a class='underline text-yellow-300' href='${opts[selected].href}' target='_blank'>click here</a>.`;
            }
            return;
          }
        }
        // fallback
        const apiUrl = `https://api.vevioz.com/api/button/${format}?url=${encodeURIComponent(url)}`;
        let win = window.open(apiUrl, '_blank');
        if(!win){
          resultDiv.innerHTML = `‚ùó Popup blocked! Please allow popups for this site. Or <a class='underline text-yellow-300' href='${apiUrl}' target='_blank'>click here</a>.`;
        }else{
          resultDiv.innerHTML = `üîó If download doesn't start, <a class='underline text-yellow-300' href='${apiUrl}' target='_blank'>click here</a>.`;
        }
        return;
      }
      // INSTAGRAM
      if (site === "instagram") {
        const apiUrl = `https://saveig.app/en/download?url=${encodeURIComponent(url)}`;
        let win = window.open(apiUrl, '_blank');
        if(!win){
          resultDiv.innerHTML = `‚ùó Popup blocked! Please allow popups for this site. Or <a class='underline text-yellow-300' href='${apiUrl}' target='_blank'>click here</a>.`;
        }else{
          resultDiv.innerHTML = `üîó Instagram downloads handled on external site. <a class='underline text-yellow-300' href='${apiUrl}' target='_blank'>Click here</a> if not redirected.`;
        }
        return;
      }
      resultDiv.innerHTML = "‚ùå Only YouTube and Instagram supported!";
    }
  </script>
</body>
</html>
