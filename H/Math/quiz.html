<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Quiz</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #fff; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container" id="level-screen">
        <h2>Select AI Difficulty</h2>
        <p>Questions are generated by Chaman AI üß†</p>
        <button class="btn-start" onclick="startAIQuiz('Easy', 'Class 1-4, Basic Arithmetic')">Easy (Class 1-4)</button>
        <button class="btn-submit" onclick="startAIQuiz('Medium', 'Class 5-8, BODMAS, Fractions')">Medium (Class 5-8)</button>
        <button class="btn-home" style="background:#d63031;" onclick="startAIQuiz('Hard', 'Class 9-10, Algebra, Trigonometry')">Hard (Class 9-10)</button>
        <button class="btn-home" onclick="location.href='index.html'">‚¨Ö Back</button>
    </div>

    <div class="container hidden" id="game-screen">
        <div style="display:flex; justify-content:space-between;">
            <span>‚≠ê Score: <span id="score">0</span></span>
            <span id="level-badge">AI Mode</span>
        </div>

        <div id="loader" class="loading-spinner hidden"></div>
        <h2 id="question" style="font-size: 24px; margin: 30px 0; min-height:60px;">Starting AI...</h2>
        
        <input type="text" id="answer" placeholder="Type answer here...">
        
        <button class="btn-submit" onclick="checkAnswer()">Submit</button>
        <button class="btn-hint" onclick="getAIHint()">üí° Ask AI for Hint (-2 pts)</button>
        <p id="msg"></p>

        <button class="btn-home" onclick="location.href='index.html'">Exit</button>
    </div>

    <script>
        const API_KEY = "AIzaSyC6KcojG7D2Uq_lHryo9c3v6wmuDtT9Rm0"; 

        let currentTopic = '';
        let currentLevel = '';
        let exactAnswer = ''; 
        let score = 0;

        function startAIQuiz(level, topic) {
            currentLevel = level;
            currentTopic = topic;
            document.getElementById('level-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('level-badge').innerText = level;
            generateAIQuestion();
        }

        async function generateAIQuestion() {
            document.getElementById('question').innerText = "AI is thinking...";
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('answer').value = '';
            document.getElementById('msg').innerText = '';

            // Updated Model: gemini-1.5-flash
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            
            const prompt = `Generate a random unique math question.
            Difficulty: ${currentLevel} (${currentTopic}).
            IMPORTANT: Return ONLY the question and the numeric answer separated by a pipe symbol (|).
            Example Output: What is 5 + 5? | 10
            Do not write anything else.`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error.message || "Unknown API Error");
                }

                const rawText = data.candidates[0].content.parts[0].text;
                
                const parts = rawText.split('|');
                if(parts.length < 2) throw new Error("AI format error: " + rawText);

                const qText = parts[0].trim();
                exactAnswer = parts[1].trim(); 

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('question').innerText = qText;
                
                let speakMsg = new SpeechSynthesisUtterance(qText);
                window.speechSynthesis.speak(speakMsg);

            } catch (e) {
                console.error(e);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('question').innerHTML = "<span style='color:red; font-size:16px;'>‚ö†Ô∏è Error: " + e.message + "</span>";
            }
        }

        function checkAnswer() {
            let userVal = document.getElementById('answer').value.trim().toLowerCase();
            let cleanExact = exactAnswer.toLowerCase();

            if (userVal === cleanExact) {
                document.getElementById('msg').innerHTML = "<span style='color:#00ff00'>‚úÖ Correct! AI: " + exactAnswer + "</span>";
                score += 5;
                document.getElementById('score').innerText = score;
                setTimeout(generateAIQuestion, 2000); 
            } else {
                document.getElementById('msg').innerHTML = "<span style='color:#ff4757'>‚ùå Wrong. Try again.</span>";
                score -= 1;
                document.getElementById('score').innerText = score;
            }
        }

        async function getAIHint() {
            if(score < 2) { alert("Not enough points!"); return; }
            score -= 2;
            document.getElementById('score').innerText = score;
            document.getElementById('msg').innerText = "AI is thinking of a hint...";

            const prompt = `The question is: "${document.getElementById('question').innerText}". 
            The answer is "${exactAnswer}". 
            Give a small hint to the student without revealing the answer.`;

            try {
                // Updated Model: gemini-1.5-flash
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const hint = data.candidates[0].content.parts[0].text;
                
                document.getElementById('msg').innerText = "üí° Hint: " + hint;
            } catch(e) {
                document.getElementById('msg').innerText = "Hint Error";
            }
        }
    </script>
</body>
</html>
