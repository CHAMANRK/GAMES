<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scream Trap Demo</title>
    <style>
        body { margin: 0; overflow: hidden; background: #2c3e50; font-family: 'Courier New', monospace; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI Layer */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; z-index: 10;
        }
        
        /* Status Bar (Lives & Coins) */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            color: white; font-size: 20px; font-weight: bold;
            pointer-events: none;
        }

        /* Buttons & Messages */
        #start-btn, #retry-btn {
            pointer-events: auto; background: #e74c3c; color: white; border: none;
            padding: 15px 40px; font-size: 22px; border-radius: 8px;
            box-shadow: 0 5px #c0392b; cursor: pointer;
        }
        #retry-btn { display: none; background: #f39c12; box-shadow: 0 5px #d35400; }
        
        #msg { color: white; font-size: 18px; margin-bottom: 20px; text-align: center; padding: 0 20px; }
        
        /* Mic Visualizer (Left Side) */
        #mic-bar {
            position: absolute; left: 0; bottom: 0; width: 15px; height: 0%;
            background: #2ecc71; transition: height 0.05s;
        }
    </style>
</head>
<body>

    <div id="hud">
        <span>❤️ <span id="lives">3</span></span>
        <span>LEVEL 1 (Demo)</span>
    </div>

    <div id="mic-bar"></div>

    <div id="ui">
        <p id="msg">Enable Mic & Scream/Speak to Jump!</p>
        <button id="start-btn">START GAME</button>
        <button id="retry-btn">TRY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- CONFIGURATION ---
        const MIC_SENSITIVITY = 15; // Noise Threshold (10-30 is good for phones)
        const JUMP_FORCE = 12;      // Max Jump Power
        const GRAVITY = 0.6;
        const SPEED = 4;            // Game Speed
        
        // --- VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const livesDisplay = document.getElementById('lives');
        const startBtn = document.getElementById('start-btn');
        const retryBtn = document.getElementById('retry-btn');
        const msg = document.getElementById('msg');
        const micBar = document.getElementById('mic-bar');

        let audioContext, analyser, dataArray;
        let isRunning = false;
        let isGameOver = false;
        let lives = 3;
        let cameraX = 0; // Screen scrolling ke liye

        // Player
        let player = { x: 100, y: 0, w: 30, h: 30, dy: 0, grounded: false, dead: false };

        // LEVEL DATA (Fixed Map for testing)
        // type: 0=Safe Ground, 1=Gap (Empty), 2=Trap (Falling Floor), 3=Spike/Enemy
        // x, y, w, h are dimensions
        let levelMap = [];

        function initLevel() {
            levelMap = [
                { type: 0, x: 0, y: 400, w: 400, h: 50 },    // Start Platform
                { type: 3, x: 300, y: 370, w: 20, h: 30 },   // Spike (Visible Danger)
                
                { type: 0, x: 550, y: 450, w: 200, h: 50 },  // Lower Platform
                
                { type: 2, x: 900, y: 400, w: 150, h: 50, falling: false }, // TRAP PLATFORM (Ye girega)
                
                { type: 0, x: 1200, y: 350, w: 300, h: 50 }, // High Platform
                { type: 3, x: 1400, y: 320, w: 20, h: 30 },  // Spike on high platform
                
                { type: 0, x: 1600, y: 400, w: 500, h: 50 }  // Finish area
            ];
            player.x = 100;
            player.y = 200;
            player.dy = 0;
            player.dead = false;
            cameraX = 0;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- AUDIO SYSTEM ---
        async function startMic() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                startBtn.style.display = 'none';
                msg.style.display = 'none';
                lives = 3;
                livesDisplay.innerText = lives;
                isRunning = true;
                isGameOver = false;
                initLevel();
                loop();
            } catch (e) {
                msg.innerText = "Mic Error: " + e.message;
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let vol = sum / dataArray.length;
            
            // UI Bar Update
            micBar.style.height = (vol * 1.5) + '%';
            return vol;
        }

        // --- PHYSICS & LOGIC ---
        function update() {
            if (player.dead) return;

            let vol = getVolume();

            // VOICE JUMP LOGIC
            if (vol > MIC_SENSITIVITY && player.grounded) {
                // Volume jitna tez, jump utni high (max 15)
                let jumpPower = Math.min(vol / 3, JUMP_FORCE);
                if (jumpPower < 8) jumpPower = 8; // Min jump
                player.dy = -jumpPower;
                player.grounded = false;
            }

            // Gravity
            player.dy += GRAVITY;
            player.y += player.dy;
            player.x += SPEED; // Auto run

            // Camera Follow
            cameraX = player.x - 100;

            // Collision Detection
            player.grounded = false;
            let onTrap = false;

            for (let obj of levelMap) {
                // Trap Falling Logic
                if (obj.type === 2 && obj.falling) {
                    obj.y += 3; // Trap gir raha hai
                }

                // Simple AABB Collision
                if (
                    player.x < obj.x + obj.w &&
                    player.x + player.w > obj.x &&
                    player.y < obj.y + obj.h &&
                    player.y + player.h > obj.y
                ) {
                    // Spike Collision (Type 3)
                    if (obj.type === 3) {
                        killPlayer();
                    }
                    // Ground Collision (Type 0 & 2)
                    else if (player.dy > 0 && player.y + player.h - player.dy <= obj.y) {
                        player.y = obj.y - player.h;
                        player.dy = 0;
                        player.grounded = true;
                        
                        // Activate Trap
                        if (obj.type === 2 && !obj.falling) {
                            setTimeout(() => { obj.falling = true; }, 200); // 0.2 sec baad girega
                        }
                    }
                }
            }

            // Death by falling
            if (player.y > canvas.height) {
                killPlayer();
            }
        }

        function killPlayer() {
            if (player.dead) return;
            player.dead = true;
            lives--;
            livesDisplay.innerText = lives;

            if (lives > 0) {
                // Respawn
                setTimeout(() => {
                    player.x = cameraX + 100; // Thoda peeche respawn
                    player.y = 0;
                    player.dy = 0;
                    player.dead = false;
                    
                    // Reset traps (Optional, abhi traps reset nahi kar rahe taki user ko trap dikhe)
                    // initLevel(); 
                }, 1000);
            } else {
                gameOver();
            }
        }

        function gameOver() {
            isRunning = false;
            msg.innerText = "GAME OVER! No Lives Left.";
            msg.style.display = 'block';
            retryBtn.style.display = 'block';
        }

        // --- DRAWING ---
        function draw() {
            ctx.fillStyle = "#2c3e50"; // Background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0); // Camera Move

            // Draw Level
            for (let obj of levelMap) {
                if (obj.type === 0) ctx.fillStyle = "#95a5a6"; // Safe Ground (Grey)
                if (obj.type === 2) ctx.fillStyle = "#7f8c8d"; // Trap (Thoda Dark Grey - deceptive)
                if (obj.type === 3) ctx.fillStyle = "#e74c3c"; // Spike (Red)
                
                ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                
                // Trap Visual Hint (Debugging ke liye hata sakte ho)
                if (obj.type === 2) {
                    ctx.strokeStyle = "orange";
                    ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
                }
            }

            // Draw Player
            ctx.fillStyle = player.dead ? "red" : "#3498db";
            ctx.fillRect(player.x, player.y, player.w, player.h);

            ctx.restore();
        }

        function loop() {
            if (!isRunning) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

        // Listeners
        startBtn.addEventListener('click', startMic);
        retryBtn.addEventListener('click', startMic);

    </script>
</body>
</html>
