<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Trap 2.0</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI Containers */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; pointer-events: none;
        }
        
        #hud {
            position: absolute; top: 10px; left: 15px;
            color: white; font-size: 18px; font-weight: bold;
            z-index: 5; text-shadow: 1px 1px 2px black;
        }

        /* Buttons */
        .btn {
            pointer-events: auto; background: #e74c3c; color: white; border: none;
            padding: 15px 30px; font-size: 20px; border-radius: 10px;
            box-shadow: 0 6px 0 #c0392b; margin-top: 10px; cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #c0392b; }
        
        #game-over-screen { display: none; background: rgba(0,0,0,0.8); width: 100%; height: 100%; position: absolute; top:0; left:0; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        
        /* Mic Meter */
        #mic-wrapper {
            position: absolute; bottom: 20px; left: 20px; width: 30px; height: 150px;
            background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 5px;
            display: flex; align-items: flex-end;
        }
        #mic-bar { width: 100%; height: 0%; background: #2ecc71; transition: height 0.08s; }

        h1 { color: white; margin-bottom: 10px; text-shadow: 2px 2px 0 #000; }
        p { color: #ccc; margin-bottom: 20px; text-align: center; padding: 0 20px;}
    </style>
</head>
<body>

    <div id="hud">
        LIVES: <span id="lives-txt">3</span> | SCORE: <span id="score-txt">0</span>
    </div>

    <div id="mic-wrapper"><div id="mic-bar"></div></div>

    <div id="ui-layer">
        <h1 id="title">VOICE TRAP</h1>
        <p>Talk to Run. Scream to Jump.<br>Wait for Silence to Stop.</p>
        <button id="start-btn" class="btn">ENABLE MIC & START</button>
    </div>

    <div id="game-over-screen">
        <h1 style="color: red;">YOU DIED</h1>
        <p>Try controlling your volume better!</p>
        <button id="retry-btn" class="btn">TRY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- GAME SETTINGS ---
        const WALK_THRESHOLD = 15;   // Isse kam awaaz ignore hogi
        const RUN_THRESHOLD = 30;    // Is range me player chalega
        const JUMP_THRESHOLD = 55;   // Isse zyada hone par jump
        
        const GRAVITY = 0.6;
        const FRICTION = 0.8;        // Player rukne ki speed (0-1)
        const MAX_SPEED = 6;         // Max running speed
        const JUMP_FORCE = -13;      // Jump height

        // --- VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const micBar = document.getElementById('mic-bar');
        const uiLayer = document.getElementById('ui-layer');
        const gameOverScreen = document.getElementById('game-over-screen');
        
        let audioContext, analyser, dataArray;
        let isRunning = false;
        let cameraX = 0;
        let lives = 3;
        let score = 0;

        // Player Object
        let player = {
            x: 50, y: 0, w: 30, h: 30,
            vx: 0, vy: 0, // Velocity X and Y
            grounded: false,
            jumpsLeft: 2, // Double jump counter
            color: '#3498db'
        };

        // Level Map (Blocks)
        let blocks = [];
        // Original Level Data (For resetting)
        const initialLevel = [
            {t:1, x:0, y:400, w:500, h:50},     // Start Ground
            {t:2, x:600, y:350, w:100, h:20},   // Floating Platform
            {t:3, x:850, y:420, w:150, h:20, trap: true}, // TRAP: Falling Floor
            {t:4, x:1100, y:300, w:50, h:150},  // Wall/Pillar
            {t:1, x:1300, y:400, w:600, h:50},  // End Area
            {t:5, x:1600, y:370, w:30, h:30}    // Spike (Red Box)
        ];

        // --- INITIALIZATION ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function resetGame() {
            player.x = 50;
            player.y = 200;
            player.vx = 0;
            player.vy = 0;
            player.jumpsLeft = 2;
            
            lives = 3;
            score = 0;
            cameraX = 0;
            
            // Deep copy level data to reset traps
            blocks = JSON.parse(JSON.stringify(initialLevel));
            
            document.getElementById('lives-txt').innerText = lives;
            gameOverScreen.style.display = 'none'; // Hide Game Over
            isRunning = true;
            loop();
        }

        // --- AUDIO ENGINE ---
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                uiLayer.style.display = 'none'; // Hide Start Menu
                resetGame();
            } catch (e) {
                alert("Mic access denied! Cannot play.");
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            
            // UI Update
            micBar.style.height = Math.min(avg * 1.5, 100) + "%";
            
            // Color change based on threshold
            if(avg > JUMP_THRESHOLD) micBar.style.background = "red";
            else if(avg > RUN_THRESHOLD) micBar.style.background = "orange";
            else micBar.style.background = "#2ecc71";
            
            return avg;
        }

        // --- PHYSICS ENGINE ---
        function update() {
            if(!isRunning) return;

            let vol = getVolume();

            // 1. MOVEMENT LOGIC (Voice to Velocity)
            
            // Horizontal Movement (Walk/Run)
            if (vol > WALK_THRESHOLD) {
                // Volume ke hisaab se speed badhegi
                let speedBoost = (vol - WALK_THRESHOLD) * 0.15;
                if(speedBoost > MAX_SPEED) speedBoost = MAX_SPEED;
                
                player.vx = speedBoost; 
            } else {
                // Agar chup ho, to friction se roko
                player.vx *= FRICTION;
            }

            // Vertical Movement (Jump)
            // Logic: Jump tab karega jab volume High ho AND (ground par ho OR double jump bacha ho)
            // Debounce: Lagatar 60fps par jump na ho, isliye vy check karte hain
            if (vol > JUMP_THRESHOLD) {
                if (player.grounded) {
                    player.vy = JUMP_FORCE;
                    player.grounded = false;
                    player.jumpsLeft = 1; // 1 jump bachi
                } 
                // Double Jump Logic (Hawa me jump)
                else if (player.jumpsLeft > 0 && player.vy > -5) { 
                    // vy > -5 isliye taki ek hi shout me dono jump waste na ho jaye
                    player.vy = JUMP_FORCE;
                    player.jumpsLeft = 0;
                }
            }

            // Apply Physics
            player.vy += GRAVITY;
            player.x += player.vx;
            player.y += player.vy;

            // Camera Follow Logic
            let targetCamX = player.x - 100;
            cameraX += (targetCamX - cameraX) * 0.1; // Smooth camera

            // 2. COLLISION DETECTION
            player.grounded = false;
            let onTrap = false;

            for (let b of blocks) {
                // Trap Logic (Falling Floor)
                if (b.trap && b.falling) {
                    b.y += 4; // Trap gir raha hai
                }

                // AABB Collision (Box vs Box)
                if (player.x < b.x + b.w && player.x + player.w > b.x &&
                    player.y < b.y + b.h && player.y + player.h > b.y) {
                    
                    // Spike Collision (Type 5)
                    if (b.t === 5) {
                        playerDie();
                    }
                    // Ground Collision (Floor se takraya)
                    else if (player.vy > 0 && player.y + player.h - player.vy <= b.y) {
                        player.y = b.y - player.h;
                        player.vy = 0;
                        player.grounded = true;
                        player.jumpsLeft = 2; // Reset jumps
                        
                        // Activate Trap
                        if (b.trap && !b.falling) {
                            setTimeout(() => { b.falling = true; }, 300); // 0.3s delay
                        }
                    }
                    // Wall Collision (Side se takraya)
                    else if (player.vx > 0) {
                        player.x = b.x - player.w;
                        player.vx = 0;
                    }
                }
            }

            // Fall Death
            if (player.y > canvas.height + 100) {
                playerDie();
            }
        }

        function playerDie() {
            lives--;
            document.getElementById('lives-txt').innerText = lives;
            
            if (lives <= 0) {
                isRunning = false;
                gameOverScreen.style.display = 'flex'; // Show Game Over
            } else {
                // Respawn Logic
                player.x = cameraX + 50; 
                player.y = 0;
                player.vy = 0;
                player.vx = 0;
            }
        }

        // --- DRAWING ---
        function draw() {
            // Clear Screen
            ctx.fillStyle = "#222";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0);

            // Draw Blocks
            for (let b of blocks) {
                if (b.t === 5) ctx.fillStyle = "red"; // Spike
                else if (b.trap) ctx.fillStyle = "#7f8c8d"; // Trap (Grey)
                else ctx.fillStyle = "#95a5a6"; // Normal Ground
                
                ctx.fillRect(b.x, b.y, b.w, b.h);
                
                // Visual Hint for Trap (Orange Border)
                if(b.trap) {
                    ctx.strokeStyle = "orange";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(b.x, b.y, b.w, b.h);
                }
            }

            // Draw Player
            // Change color based on voice state
            ctx.fillStyle = player.color;
            if(player.vy < 0) ctx.fillStyle = "#e74c3c"; // Jumping Color
            else if(player.vx > 1) ctx.fillStyle = "#f1c40f"; // Running Color
            
            ctx.fillRect(player.x, player.y, player.w, player.h);

            ctx.restore();
            
            if(isRunning) requestAnimationFrame(loop);
        }

        function loop() {
            update();
            draw();
            if(isRunning) requestAnimationFrame(loop);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('start-btn').addEventListener('click', () => {
             if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            initAudio();
        });
        
        document.getElementById('retry-btn').addEventListener('click', resetGame);

    </script>
</body>
</html>
